<html>
  <head>

    <title>cors-light tests</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">

    <script src="../../web-component-tester/browser.js"></script>
    <script src="../lib/client.js"></script>

  </head>
  <body>

    <script>

      // Requires spoofing banquet.notadomain.com as localhost

      var port = document.location.port;
      port = port ? ':' + port : '';

      var base = 'http://banquet.notadomain.com' + port + '/components/cors-light/test';
      var uri = base + '/server.html';

      var error = null;
      var client = new CorsLight.Client(uri, function(err) {

        error = err;
      });

    </script>

    <script>
      describe('cors-light', function() {

        describe('server', function() {

          it('manifest respects origins specified as an array.', function(done) {

            client.get('accessArray', function(err, result) {

              expect(err).to.not.exist;
              done();
            });
          });

          it('manifest respects origin specified as a string.', function(done) {

            client.get('accessString', function(err, result) {

              expect(err).to.not.exist;
              done();
            });
          });

        });

        describe('client', function() {

          beforeEach(function() {
            error = null;
          });

          it('can get() using promises and callbacks.', function(done) {

            client.get('access', function(err, result) {

              expect(err).to.not.exist;
              expect(result).to.deep.equal({ value: true, expire: false });

              client.get('noAccess', function(err, result) {

                expect(err).to.exist;
                expect(result).to.not.exist;

                client.get('access').then(function(result) {

                  expect(result).to.deep.equal({ value: true, expire: false });

                  client.get('noAccess').catch(function(err) {

                    expect(err).to.exist;
                    done();
                  });

                });

              });

            });

          });

          it('can set() using promises and callbacks.', function(done) {

            client.set('access', 'set was here', function(err, setResult) {

              expect(err).to.not.exist;
              expect(setResult).to.not.exist;

              client.get('access').then(function(result) {

                expect(result.value).to.equal('set was here');

                return client.set('access', 'set was here again')
              })
              .then(function(setResult) {

                expect(setResult).to.be.not.exist;

                return client.get('access');
              })
              .then(function(result) {

                expect(result.value).to.equal('set was here again');
                done();
              });

            });

          });

          it('can unset() using promises and callbacks.', function(done) {

            // Success path, lots of checking to do
            client.get('access').then(function(result) {

              expect(result.value).to.equal('set was here again');

              client.unset('access', function(err, unsetResult) {

                expect(err).to.not.exist;
                expect(unsetResult).to.not.exist;

                client.get('access').then(function(result) {

                  expect(result).to.equal(null);

                  return client.set('access', 'key is reset')
                })
                .then(function() {

                  return client.unset('access');
                })
                .then(function(unsetResult) {

                  expect(unsetResult).to.not.exist;

                  return client.get('access');
                })
                .then(function(result) {

                  expect(result).to.equal(null);

                  // Error path
                  client.unset('noAccess', function(err, unsetResult) {

                    expect(err).to.exist;
                    expect(unsetResult).to.be.not.exist;

                    client.unset('noAccess').catch(function(err) {

                      expect(err).to.exist;
                      done();
                    });

                  });
                })
                .catch(done); // Would be a failure

              });

            });

          });

          it('set() method can specify no ttl.', function(done) {

            client.set('access', 'forever')
            .then(function() {

              return client.get('access')
            })
            .then(function(result) {

              expect(result.value).to.equal('forever');
              expect(result.expire).to.equal(false);
              expect(result.session).to.not.exist;

              done();
            }).catch(done);

          });

          it('set() method can specify a numeric ttl.', function(done) {

            client.set('access', 'transient', 10)
            .then(function() {

              return client.get('access')
            })
            .then(function(result) {

              expect(result.value).to.equal('transient');
              expect(result.expire).to.be.a('number');
              expect(result.expire - Date.now()).to.be.within(0, 10);
              expect(result.session).to.not.exist;

              setTimeout(function() {

                client.get('access').then(function(result) {

                  expect(result).to.equal(null);
                  done();

                }).catch(done);

              }, 10);

            }).catch(done);

          });

          it('set() method can specify a sessioned ttl.', function(done) {

            client.set('access', 'transient', 'session')
            .then(function() {

              return client.get('access')
            })
            .then(function(result) {

              expect(result.value).to.equal('transient');
              expect(result.expire).to.not.exist;
              expect(result.session).to.exist;

              // Clear session on server's domain
              var clearSession = document.createElement('iframe');
              clearSession.src = base + '/clear-session.html';
              document.body.appendChild(clearSession);
              clearSession.onload = function() {

                document.body.removeChild(clearSession);

                client.get('access')
                .then(function(result) {

                  expect(result).to.equal(null);
                  done();
                }).catch(done);

              };

            }).catch(done);

          });

        });

      });
    </script>

  </body>
</html>
